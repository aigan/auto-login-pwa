<!DOCTYPE html>
<link rel="icon" href="/img/jonas-2016-300.jpg">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="main.js"></script>
<body>
	<header>
		<section><span id="status">Loading</span></section>
		<spacer></spacer>
		<section class="logged-in"><button id="logout">Logout</button></section>
	</header>

	<main class="logged-out">
		<section class="login-alternatives">
			<h1>You wanna log in?</h1>
			<button id="a_login" disabled>Log in</button>
			<button id="p_login" disabled><spinner></spinner>with Password</button>
			<button id="g_login" disabled><spinner></spinner>with Google</button>
			<button id="f_login" disabled>with Facebook</button>
		</section>
		<form class="login-password">
			<paper-input name="username" label="Name" type="text" autocomplete="username"></paper-input>
			<paper-input name="password" label="Password" type="password" autocomplete="current-password"></paper-input>
			<paper-button class="submit" raised>Login</paper-button>
			<input hidden="true" type="submit">
		</form>
	</main>
	<main class="logged-in">
		<p>It's a brand new world</p>
		<button id="a_forget">Forget me</button> on this device

		<section class="user-info">
			<pre class="local"></pre>
			<pre class="password"></pre>
			<pre class="google"></pre>
			<pre class="facebook"></pre>
		</section>
	</main>

</body>
<style>
html {
	font-size: 16px; 
}
body {
	margin: 0;
	font-family: sans-serif;
}

header {
	display: flex;
	width: 100%;
	background: grey;
	min-height: 4em;
	flex-direction: row;
	box-sizing: border-box;
}

header, main {
	padding: 0.2em 1em;
}

spacer {
	flex-grow: 1;
}

.logged-in, form.login-password {
	display: none;
}



header section {
	display: flex;
	flex-direction: column;
	justify-content: center;
}

header button {
	display: block;
}

button {
	font-size: 110%;
	padding: 0.4em 0.8em;
}

button:disabled {
	opacity: 0.2;
}

.login-password {
	text-align:center;
	max-width: 30em;
	margin: auto;
}

.login-password paper-input {
	text-align:left;
}

.login-password paper-button.submit {
	margin: 1.2em 0 0 0;
	width: 100%;
	color: white;
	background: #4059A9;
}


spinner {
	content: "";
	display: inline-block;
	width: 0;
	height: 0;
	border: solid 0.5em;
	border-radius: 0.5em;
	border-color: #0099ff transparent #0099ff transparent;
	animation: spin 1s linear infinite;
}
@keyframes spin{
	0% {
		transform: rotate(0deg);
	}
	100% {
		transform: rotate(360deg);
	}
}

.login-alternatives button {
	position: relative;
}

.login-alternatives button spinner {
	position: absolute;
	display: none;
}
.login-alternatives button:disabled spinner {
	display: block;
}
.login-alternatives[cred_used]	button:disabled spinner {
	display: none;
}

</style>
<script>
"use strict";
log('index');

class Supplier {
	constructor(lib, origin) {
		this.lib = lib;
		this.origin = origin; // Federated identity providor
		this.label = null; // Will be set after cunstruction..
		this.ready = false;
		this.exec = null;
		this.promise = null;
		log("Constructing "+lib);
	}

	then(f) {
		if(!this.promise) {
			var sup = this;
			this.promise = new Promise(function(resolve,reject){
				loadScriptAsync(sup.lib, function(){
//					log("Lib loaded. Calling sup.exec");
					sup.exec(resolve,reject);
				});
			});
		}
		this.promise.then(f);
		return this;
	}
}

var u; // User
var s = // Supplier
{
	google: new Supplier('supplier/google.js',"https://accounts.google.com"),
	password: new Supplier('supplier/password.js'),
	facebook: {
		ready: false,
		origin: "https://www.facebook.com",
	},
	//		 test: new Supplier('supplier/test.js'),
};

var originIndex = {};
for( let sup in s ) {
	if(!s[sup].origin) continue;
	originIndex[s[sup].origin] = s[sup];
	s[sup].label = sup;
	log("%s: %s", sup, s[sup].origin);
}

// s.test.then(()=>log("Test loaded"));


var config_promise = fetch("config.json").then( r=>r.json() );

class User {
	constructor(p) {
		if(!p) p = {};
		this.loggedin = p.loggedin || false;
		this.id = p.id;
		this.cred_used = p.cred_used;
		this.s = {};
	}
}


function notifyStatus(msg) {
	fromId('status').innerHTML = msg;
}

function autoLogin() {
	log("autoLogin");
	if( u.loggedin ) {
		notifyStatus("Welcome back");
		onLogin();
	} else if( u.id && u.cred_used ) {
		// Identified but logged out. Respect that
		notifyStatus("");
		drawLoginWidget();
	} else if ( !!navigator.credentials ) {
		a_login();
	} else {
		//Handle sign-in the way you did before.
		log("No cred support");
		notifyStatus("Your browser do not support credentials manager");
		drawLoginWidget();
	};
}

function doForget() {
	for( let sup of Object.keys(s) ) {
		if( s[sup].forget ) s[sup].forget();
	}

	if( !!navigator.credentials )
		navigator.credentials.requireUserMediation();
	
	notifyStatus("Logged out. Remeber to clear your device");
	u = new User();
	Lockr.rm('user');
	onLogout();
}

function a_login(by_click) {
	notifyStatus("Trying to log in");
	fromId('a_login').disabled = true;
	
	
	if(!navigator.credentials) {
		if( u.cred_used ) {
			return s[u.cred_used].then(_=>s[u.cred_used].login());
		}

		notifyStatus("Your browser do not support credentials manager");
		u.cred_used = null;
		drawLoginWidget();
		return;
	}

	navigator.credentials.get({
		password: true,
		federated: {
			providers: Object.keys(originIndex),
		},
		unmediated: true,
	}).then( cred => navcredLogin(cred, by_click) );
}

function navcredLogin( cred, by_click ) {
	if( !cred ) {
		log("No cred");
		notifyStatus("No login credentials found");
		u.cred_used = null;
		userUpdate();
		drawLoginWidget();
		return;
	}

	if( cred.type == 'password' ) {
		s.password.then(_=>s.password.navcredLogin(cred, by_click));
	} else if( cred.type == 'federated' ) {
		log("Trying federated login");
		var sup = originIndex[cred.provider];
		if( sup )
			return sup.then(_=>sup.navcredLogin(cred, by_click));

		log("Unhandled federated provider");
		log(cred.provider);
	}
}

function onLogin() {
	for(var item of queryAll('header .logged-in')) item.style.display = "flex";
	for(var item of queryAll('main.logged-in')) item.style.display = "block";
	for(var item of queryAll('.logged-out')) item.style.display = "none";
	query('.login-alternatives').style.display = 'block';
	query('.login-password').style.display = 'none';
}

function onLogout() {
	for(var item of queryAll('.logged-in')) item.style.display = "none";
	for(var item of queryAll('header .logged-out')) item.style.display = "flex";
	for(var item of queryAll('main.logged-out')) item.style.display = "block";
	drawLoginWidget();
}

function drawLoginWidget() {
	query('.login-alternatives').setAttribute('cred_used',u.cred_used);
	fromId('a_login').disabled = !u.cred_used;
	if( !u.cred_used ) {
		fromId('p_login').disabled = !s.password.then().ready;
		fromId('g_login').disabled = !s.google.then().ready;
		fromId('f_login').disabled = !s.facebook.ready;
	} else {
		fromId('p_login').disabled = true;
		fromId('g_login').disabled = true;
		fromId('f_login').disabled = true;
	}
}

function userUpdate() {
	Lockr.set('user', {
		id: u.id,
		loggedin: u.loggedin,
		cred_used: u.cred_used,
	});
	onUserUpdated();
}

function onUserUpdated() {
	query('.user-info .local').innerHTML =
	`id: ${u.id}\ncred: ${u.cred_used}`;

	Object.keys(s).forEach( sup => {
		log(sup);
		if( u.cred_used == sup )
			s[sup].then(_=> {
				if(s[sup].onUserUpdated)
					s[sup].onUserUpdated();
			});
	});
}

loadScriptAsync("/vendor/lockr/lockr.min.js", function(){
	u = new User(Lockr.get('user'));

	if( u ) {
		onUserUpdated();
	} else {
		u = new User();
		userUpdate();
	}
	
	fromId('logout').onclick = function(){
		// navigator.credentials.requireUserMediation();
		notifyStatus("Logged out");
		u.loggedin = false;
		userUpdate();
		onLogout();
	}

	fromId('p_login').onclick = function(){ s.password.login(1) };

	fromId('g_login').onclick = function(){ s.google.login(1) };
	
	fromId('a_login').onclick = function(){ a_login(1) };
	
	fromId('a_forget').onclick = doForget;

	autoLogin();
});

log("index init");
</script>
